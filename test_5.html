<html>
	<head>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
		<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCLhw12hTzbrWIAIepH3EoDvKGs1WhetTQ"></script>
		
		<script type="text/javascript">
			// Initialize the global map //
			var map; var homeMarker; var workMarker;
		
			var prontoMarkers = [];
			
			var prontoIcon =  {
				url : 'https://s3.amazonaws.com/geohackers-for-good/pronto_logo_hexa_hosted.svg',
				scaledSize: new google.maps.Size(30,30),
				origin: new google.maps.Point(0,0),
				anchor: new google.maps.Point(15, 15)
			};
			
				
			// What is the data structure of a polygon? //
			var clickablePolygons = [];

			var infoWindow = new google.maps.InfoWindow( { size: new google.maps.Size(100,50) } );
			
			var geocoder     = new google.maps.Geocoder();
			var geocoder_re  = null;

			// DirectionService //
			var directionsService = new google.maps.DirectionsService();
			var directionsDisplay = new google.maps.DirectionsRenderer();
		
			// Home to Work //
				// Consider origin/dest 
			var home = {};
			var work = { 
							latLng : new google.maps.LatLng(47.6222788,-122.336828599), 
							address: '1100 2nd Ave #500, Seattle, WA 98101'
						}; 
			
				// Fill this in with the latLng of the HTTP request //
							 // ASK ADRIENNE about this variable :D !!!
								// We should be able to get with WITHOUT parsing the URL 
			
			var ltlng = null;
			
			// Here are the Pronto neighborhoods //
			
			var pronto_available_neighborhoods =
				[	'Westlake',
					'Laurelhurst',
					'Ravenna',
					'Bryant',
					'Portage Bay',
					'Montlake',
					'Broadway',
					'First Hill',
					'Yesler Terrace',
					'Pioneer Square',
					'International District', 
					'Belltown', 	
					'Eastlake',
					'South Lake Union',
					'Lower Queen Anne',
					'East Queen Anne'
				];
			
			// This function is called after the HTML is finished loading. 
			// It is passed in as a callback to:
				// google.maps.event.addDomListener(window, 'load', initialize);
			function initialize() {
						
					var mapCanvas  = document.getElementById('map-canvas');

					var mapOptions = {
										mapTypeId : google.maps.MapTypeId.ROADMAP,
										center    : new google.maps.LatLng(47.6222788,-122.336828599),
										zoom      : 13
									 };
					
					// This creates the actual map object and attaches it to the HTML object //
					map = new google.maps.Map( mapCanvas, mapOptions );

					/////////////////// Load the Data ! ///////////////////
					
					// Loads the big, neighborhood data-JSON //

					// Sorted by neighborhood name 
						// Make "type":"Neighborhood"
						// Make this have a callback for the infoWindow //
					neighborhoodStyles = {
						fillColor     : 'green',
						fillOpacity   : 0.7,
						strokeColor   : 'blue',
						strokeOpacity : 0.6,
						strokeWeight  : 8
					};
							
					map.data.loadGeoJson('https://s3.amazonaws.com/work-orbit/all_Seattle_data_test.geojson', {idPropertyName:"name"},
						function (polys) 
						{
							// Set the neighborhood styling //
							polys.forEach( 
								function(poly){
									map.data.overrideStyle(poly, neighborhoodStyles);
								}
							);
							
							// Add in the click handlers //
							
						}
					);
						
					// Sorted by "type":"Pronto"
						// Toggle Pronto Icons //
					var prontoIcon =  {
						url : 'https://s3.amazonaws.com/geohackers-for-good/pronto_logo_hexa_hosted.svg',
						scaledSize: new google.maps.Size(30,30),
						origin: new google.maps.Point(0,0),
						anchor: new google.maps.Point(15, 15)
					};

					prontoStyles = { 
						icon: prontoIcon,
						visible: true,
						clickable: true 
					}; // Set title to the station.address 
						
					map.data.loadGeoJson('https://s3.amazonaws.com/work-orbit/formatted_pronto_locations_aug.geojson', {idPropertyName:"name"},
						function (pronto_points) 
						{
							pronto_points.forEach( 
								function(pronto_point){
									map.data.overrideStyle(pronto_point, prontoStyles);
								}
							);
						}
					);

					
					// MARKERS!!! //
					
					var homeIcon =  {
										url : 'https://s3.amazonaws.com/geohackers-for-good/home.svg',
										scaledSize: new google.maps.Size(30,30),
										origin: new google.maps.Point(0,0),
										anchor: new google.maps.Point(15, 15)
									};
									
					homeMarker = new google.maps.Marker(
						{	
							position: new google.maps.LatLng(47.6222788,-122.336828599), // latLng,
							map : null,
							icon: homeIcon								
						}
					);							
												
					// Work Markers ! //
										
					// Work Address //
					if ( work.address === null ) {
						// Add a work address to show a marker //
						work.address = '1100 2nd Ave #500, Seattle, WA 98101';
						work.latLng  = new google.maps.LatLng(47.6222788,-122.336828599); 
					}   // We will have to GeoCode this when we connect it all //
					
					
					var workIcon =  {
										url : 'https://s3.amazonaws.com/geohackers-for-good/briefcase.svg',
										scaledSize: new google.maps.Size(30,30),
										origin: new google.maps.Point(0,0),
										anchor: new google.maps.Point(15, 15)
									};					
																		
					workMarker = new google.maps.Marker(
						{	
							position: work.latLng,
							map     : map,
							icon    : workIcon								
						}
					);					
						

					// Promisify this... for now, just time it //					
						// This is a hack. It should really be after the GeoJSON has loaded //
					setTimeout(
					function(){
					
						// Add the click listener for events //
						map.data.addListener('click', function(event) {
						
							// Save the latLng to anchor the marker and the infoWindow // 
								// console.log(event.latLng);
							ltlng = event.latLng;
							
							// Set the homeMarker //							
								// This checks the initial condition, where we do not want 
								//	it to appear on the map before clicking.
							if (homeMarker.map === null) {
								homeMarker.setMap(map);
							}

							// This changes the position property on the global variable. 
							homeMarker.setPosition(ltlng);
							home.latLng = ltlng;							
								// How can we adjust the work marker? //
							
							// Run the Geocoder //
							geocoder.geocode( {'latLng':ltlng },
								function(res, status){ 
									if (res){ 
										var address  = res[0].formatted_address.split(',')[0];
										console.log('Address at', address);
										geocoder_re  = res; // We can talk about formatting here //
										home.address = address; 
									} else {
										console.log('Unable to obtain address for the provided coords.');
									}
								}
							);
						
							// Check if the current neighborhood is in the list //
							if (pronto_available_neighborhoods.indexOf(event.feature['k']['name']) > -1 ){
								console.log('Pronto is available here!');
								turnOnProntoMarkers();
							} else {
								console.log('Pronto NOT available here');
								turnOffProntoMarkers();
							}
							
							// Populate the string // 
							data_str  = '<div> Welcome to ' + event.feature['k']['name'] + '. ';
							data_str += 'The median household income is ' + event.feature['k']['Median_Household_Income'] + '. ';
							data_str += 'The average commute takes ' + event.feature['k']['Median_Commute_Time'] + ' minutes. ';
							data_str += 'The following jobs are common here: ';
							data_str += '<ul>';
							event.feature['k']['Employment'].forEach( function(job) {
								data_str += '<li>' + job + '</li>';
							});
							data_str += '</ul><br><div>';
							
							
							// See how we can add Walkscore the the exact point //
						
							infoWindow.setContent(data_str);
							
							var anchor = new google.maps.MVCObject();
							anchor.set("position",event.latLng);
							infoWindow.open(map,anchor);
							
						});					
					}					
					, 3500);
											
			} // The initialize function ends here //
					


					function turnOffProntoMarkers () {
							map.data.forEach(
												function( datum ) { 													
													if ( datum.k.type === 'Pronto') { 												
														map.data.overrideStyle( datum, { visible: false });												
													}
												}
							);
					}
					
					function turnOnProntoMarkers () {
							map.data.forEach(
												function( datum ) { 													
													if ( datum.k.type === 'Pronto') { 												
														map.data.overrideStyle( 
															datum, { visible: true, icon: prontoIcon }
														);
													}
												}
							);
					}
					
				// Set general Stylers //
				
					
				// This calls the initialize() function (above) after the page loads //
				google.maps.event.addDomListener(window, 'load', initialize);	
				
/*					
					
					// Make a function for computeCommute() //
						// Should we make it work to home? 
						// OR origin to destination      ?

// if mode = 'home_2_work' -> origin = home.latLng, destination = work.latLng;
// if mode = 'work_2_home' -> origin = work.latLng, destination = home.latLng;
					
							var dir_result;
							var directions = []; // Store an array of points :D // 
							function calcRoute() {
								// Have a binary switch on the modes //
								var request = 	{
													origin:home.latLng,
													destination:work.latLng,
													travelMode: google.maps.TravelMode.DRIVING,
													unitSystem: google.maps.UnitSystem.IMPERIAL ,
													durationInTraffic: true         ,
													provideRouteAlternatives: true
												};
												
								directionsService.route(request, function(result, status) {
									if (status == google.maps.DirectionsStatus.OK) {
										// Store to retrieve outside //
										dir_result = result;
										
										// Color the direction on the map //
										directions = null;
										directions = []; // Should I set it to null first?
										
										// Add them to the array //
										dir_result.routes[0].overview_path.forEach(
											function( dir_point ) {
												// Color it and make them removable! //
													// Add them to a global ? // 
												new_point = new google.maps.LatLng( dir_point.lat(), dir_point.lng() )
												directions.push( new_point );
											}
										);
										
										// Display and Style! //
										
										google.maps.Data.LineString( directions );
										
										//directionsDisplay.setDirections(result);
									}
								});
							}			
		*/
				
		</script>
	<head>
	
	<body>
		
		<div>
			<h2>Hello!</h2>
		</div>
		
		<style>
			#map-canvas {
				width: 80%;
				height: 80%;
			}
		</style>
		
		<div id="map-canvas">
		</div>
		
	</body>
</html>